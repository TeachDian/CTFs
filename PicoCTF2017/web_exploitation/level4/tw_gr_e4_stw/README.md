# PicoCTF2017  
## Writeup for Toaster Wars: Going Rogue Episode 4  

```
Many saw the fourth installment of Toaster Wars: Going Rogue as a return to grace after
the relative mediocrity of the third. I'm just glad it was made at all. And hey, they
added some nifty new online scoreboard features, too!
```

Before we write about anything specific to this problem, it's important to note that it is the fourth problem of a series. It would be silly to act like this was the first, so I'll just write down a list of things we've learned from the previous problems.  

* The backend for the game is using Node.js
* The game serves static files, but the source of the static files seems to be the root of the server. This means that we can view files such as /package.json, which show links to the server code.
* The server is located at /server/serv.js
* The game code is located at /server/game.js
* The core parts of the game are all secure. You cannot trick the game into moving you into any location. You cannot trick the server into putting a flag in your inventory, or anything of that sort.  

Next, we'll check what's different about this version from the others. Below are the hints:  

```
Ooh, what a nifty scoreboard! If we get a bunch of people
playing at once, we can have a race through the dungeon!
```

Looks like a scoreboard has been added. But the hint also alludes to getting a bunch of people to play. This made us think that the problem could have something to do with a random chance that would take many attempts to do.  

The first thing we did was take a normal run through the game. The last floor seems to have a set of stairs encased in blocks. Like I said in the list above, most of the core mechanics of the game are secure, so I know I can't just trick the server into making me walk through the walls or anything.  

The first idea for an exploit involved an item that teleported you to a random location on the map. We wondered if it could have teleported us onto the stairs.  

We looked into the code for where that item is used, and saw the snippet below:  

```JavaScript
    case "move":
                switch(effect.location){
                    case "random":
                        var newloc = { r: Math.floor(Math.random() * state.map.height), c: Math.floor(Math.random() * state.map.width) };

                        while(state.map.grid[newloc.r][newloc.c] <= 0
                              || (state.map.stairs.r == newloc.r && state.map.stairs.c == newloc.c)
                              || utils.getEntityAtLocation(state, newloc.r, newloc.c) != null){
                            newloc = { r: Math.floor(Math.random() * state.map.height), c: Math.floor(Math.random() * state.map.width) };
                        }

                        outcome.moveType = "warp";
                        outcome.location = newloc;
                        entity.location = newloc;
                        break;
                }
                break;
```
        
Unfortunately, if the location is equal to the location of the stairs, then a new location is generated. Therefore, this is not the right solution.  

After that, we were stumped for a while. We knew that the core movement functions were safe. How on earth could we reach the stairs? The map generator seemed like the next place to go to. We stumbled upon this piece of code in /server/generator.js:  

```JavaScript
    // Place player

            var playerLocation = {r: Math.floor(Math.random()*opts.map.height), c: Math.floor(Math.random()*opts.map.width)};

            while(grid[playerLocation.r][playerLocation.c] <= 0){
                playerLocation = {r: Math.floor(Math.random()*opts.map.height), c: Math.floor(Math.random()*opts.map.width)};
            }

            // Place stairs

            var stairsLocation = {r: Math.floor(Math.random()*opts.map.height), c: Math.floor(Math.random()*opts.map.width)};

            while(grid[stairsLocation.r][stairsLocation.c] <= 0 || (stairsLocation.r == playerLocation.r && stairsLocation.c == playerLocation.c)){
                stairsLocation = {r: Math.floor(Math.random()*opts.map.height), c: Math.floor(Math.random()*opts.map.width)};
            }

            if (opts.unfair) {
                grid[stairsLocation.r - 1][stairsLocation.c - 1] = -1;
                grid[stairsLocation.r - 1][stairsLocation.c] = -1;
                grid[stairsLocation.r - 1][stairsLocation.c + 1] = -1;
                grid[stairsLocation.r][stairsLocation.c - 1] = -1;
                grid[stairsLocation.r][stairsLocation.c + 1] = -1;
                grid[stairsLocation.r + 1][stairsLocation.c - 1] = -1;
                grid[stairsLocation.r + 1][stairsLocation.c] = -1;
                grid[stairsLocation.r + 1][stairsLocation.c + 1] = -1;
            }
```

To put this code into easy to understand English:  

1. The spawn location of the player is decided.
2. The location of the stairs is decided.
3. The code makes sure that the player did not spawn on the stairs.
4. The walls around the stairs are made.

So what does this mean? There is *nothing* in the code that prevents the player from spawning on top of one of the blocks around the stairs. Because the collision checker in the move functions only looks at where the player is moving to, and not where the player currently is, we can spawn on the blocks and take one step to land on the stairs. This also fits the hint in the case that it's something that you would need a lot of players running through the dungeon to get it. This is obviously something very rare.  

We thought about writing bots to do it, but in the end, we just decided to countlessly run it. We calculated the chance to be about one in three hundred. By the time we could have written a bot to constantly run the dungeon perfectly, we could have just manually gotten the flag anyway.  

We used a certain trick to accomplish this much faster. If on the first level, we did not spawn within a few tiles of the stairs, we refreshed. This made it much easier to reach the last floor.  

Unfortunately, we didn't count, but it took about 100-322 times to get it.

```
Flag: im_still_upset_you_dont_get_to_keep_the_cute_scarves_in_the_postgame_a44703668b068b3fa9a7a83a8f466ace
```
